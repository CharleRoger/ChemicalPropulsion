// Create engine controller
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechPropellant],!MODULE[ModuleIgnitionEngineController]]:BEFORE[zzz_ChemicalPropulsion]
{
	MODULE
	{
		name = ModuleIgnitionEngineController
		moduleID = chemTechPropellant
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel],!MODULE[ModuleIgnitionEngineController]]:BEFORE[zzz_ChemicalPropulsion]
{
	MODULE
	{
		name = ModuleIgnitionEngineController
		moduleID = chemTechFuel
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechAdditive]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]
	{
		@moduleID = #$moduleID$Additive
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechOxidizer]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]
	{
		@moduleID = #$moduleID$Oxidizer
	}
}

// Assign engineID if available
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechPropellant,#engineID]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Propellant*]]
	{
		engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechPropellant,#engineID]/engineID$
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel,#engineID]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Fuel*]]
	{
		engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechFuel,#engineID]/engineID$
	}
}

// Create additional engine controller for MultiModeEngine
// LOX-augmented NTRs
@PART:HAS[@MODULE[MultiModeEngine],@MODULE[ModuleEngines*]:HAS[#chemTechPropellant[LqdHydrogen]],@MODULE[ModuleEngines*]:HAS[#chemTechPropellant[LqdHydrogen],#chemTechOxidizer[LqdOxygen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechMultiModeEngineSupported = true
	@MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechPropellant
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechPropellant[LqdHydrogen]]/engineID$
	}
	+MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechPropellantOxidizer
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechPropellant[LqdHydrogen],#chemTechOxidizer[LqdOxygen]]/engineID$
	}
}
// LOX-augmented jets
@PART:HAS[@MODULE[MultiModeEngine],@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],@PROPELLANT[IntakeAir]],@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[LqdOxygen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechMultiModeEngineSupported = true
	@MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechFuel
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],@PROPELLANT[IntakeAir]]/engineID$
	}
	+MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechFuelOxidizer
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[LqdOxygen]]/engineID$
	}
}
@PART:HAS[@MODULE[MultiModeEngine],@MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdHydrogen],@PROPELLANT[IntakeAir]],@MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdHydrogen],#chemTechOxidizer[LqdOxygen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechMultiModeEngineSupported = true
	@MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechFuel
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdHydrogen],@PROPELLANT[IntakeAir]]/engineID$
	}
	+MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechFuelOxidizer
		%engineID = #$../MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdHydrogen],#chemTechOxidizer[LqdOxygen]]/engineID$
	}
}
// Bimodal jets
@PART:HAS[@MODULE[MultiModeEngine],@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],@PROPELLANT[IntakeAir]],!MODULE[ModuleEngines*]:HAS[!PROPELLANT[IntakeAir]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechMultiModeEngineSupported = true
	@MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechFuel1
		%engineID = #$../MODULE[ModuleEngines*],0/engineID$
	}
	+MODULE[ModuleIgnitionEngineController]
	{
		@moduleID = chemTechFuel2
		@engineID = #$../MODULE[ModuleEngines*],1/engineID$
	}
}
@PART:HAS[@MODULE[MultiModeEngine],@MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdHydrogen],@PROPELLANT[IntakeAir]],!MODULE[ModuleEngines*]:HAS[!PROPELLANT[IntakeAir]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechMultiModeEngineSupported = true
	@MODULE[ModuleIgnitionEngineController]
	{
		%moduleID = chemTechFuel1
		%engineID = #$../MODULE[ModuleEngines*],0/engineID$
	}
	+MODULE[ModuleIgnitionEngineController]
	{
		@moduleID = chemTechFuel2
		@engineID = #$../MODULE[ModuleEngines*],1/engineID$
	}
}

// Don't need an additional engine controller for an electric fan, since there is no fuel
// so just mark these as supported so the fuelled engine will get a Ignition switch
@PART:HAS[@MODULE[MultiModeEngine],@MODULE[ModuleEngines*]:HAS[#chemTechFuel,@PROPELLANT[IntakeAir]],@MODULE[ModuleEngines*]:HAS[~chemTechFuel,@PROPELLANT[ElectricCharge],@PROPELLANT[IntakeAtm]]]:BEFORE[zzz_ChemicalPropulsion]
{
	chemTechMultiModeEngineSupported = true
}

// Prevent engine controller from targeting built-in engines on tanks which use a different propellant, e.g. solid fuel separators on external bipropellant tanks
@PART:HAS[#chemTechFuel,#chemTechOxidizer,!MODULE[ModuleEngines*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController],*
	{
		%engineID = none
	}
}
@PART:HAS[#chemTechPropellant[LqdHydrogen],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[LqdHydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController],*
	{
		%engineID = none
	}
}
@PART:HAS[#chemTechFuel[LqdHydrogen],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[LqdHydrogen]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController],*
	{
		%engineID = none
	}
}
@PART:HAS[#chemTechPropellant[HTP],!MODULE[ModuleEngines*]:HAS[@PROPELLANT[MonoPropellant]]]:BEFORE[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController],*
	{
		%engineID = none
	}
}

// Connect propellant modules to engine controller modules
@PART:HAS[@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Propellant*]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Propellant*]],*
	{
		propellantModuleID = chemTechPropellant
	}
}
@PART:HAS[@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Fuel*]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Fuel*]],*
	{
		propellantModuleID = chemTechFuel
	}
}
@PART:HAS[@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		propellantModuleID = chemTechOxidizer
	}
}

// Tag engine controllers with hypergolic ignitor resources for switch
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[IWFNA]]]:AFTER[zz_ChemicalPropulsion]
{
	@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[IWFNA]],*
	{
		chemTechIgnitor = Aniline
		chemTechIgnitor = Hydrazine
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[NTO]]]:AFTER[zz_ChemicalPropulsion]
{
	@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[NTO]],*
	{
		chemTechIgnitor = Aniline
		chemTechIgnitor = Hydrazine
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Aniline],#chemTechOxidizer[LqdOxygen]]]:AFTER[zz_ChemicalPropulsion]
{
	@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Aniline],#chemTechOxidizer[LqdOxygen]],*
	{
		chemTechIgnitor = IWFNA
		chemTechIgnitor = NTO
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Hydrazine],#chemTechOxidizer[LqdOxygen]]]:AFTER[zz_ChemicalPropulsion]
{
	@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Hydrazine],#chemTechOxidizer[LqdOxygen]],*
	{
		chemTechIgnitor = IWFNA
		chemTechIgnitor = NTO
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[LqdOxygen]]]:AFTER[zz_ChemicalPropulsion]
{
	@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene],#chemTechOxidizer[LqdOxygen]],*
	{
		chemTechIgnitor = TEATEB
	}
}

// Add electric ignitor to cryogenic engines and jet engines
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Lqd*]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[!IGNITION_RESOURCE,#moduleID[chemTech*Oxidizer*]],*
	{
		IGNITION_RESOURCE
		{
			name = ElectricCharge
			ScaledAmount = 0.1
			AddedIgnitionPotential = 0.5
		}
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel,@PROPELLANT[IntakeAir]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[!IGNITION_RESOURCE,#moduleID[chemTech*Fuel*]],*
	{
		IGNITION_RESOURCE
		{
			name = ElectricCharge
			ScaledAmount = 1
			AddedIgnitionPotential = 1
		}
	}
}

// Add fixed ignitors to non-hypergolic engines
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Ethanol]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[Kerosene]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdHydrogen]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdMethane]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechFuel[LqdAmmonia]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechOxidizer[LqdOxygen]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}
@PART:HAS[@MODULE[ModuleEngines*]:HAS[#chemTechOxidizer[HTP]]]:FOR[zzz_ChemicalPropulsion]
{
	@MODULE[ModuleIgnitionEngineController]:HAS[#moduleID[chemTech*Oxidizer*]],*
	{
		%FixedIgnitors = 1
	}
}